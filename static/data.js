// Query string parameters.
const QUERY_PARAMS = new Proxy(new URLSearchParams(window.location.search), {
    get: (searchParams, prop) => searchParams.get(prop),
});

// Use LZString library for decompression
function decompressFromBase64(compressedString) {
    return LZString.decompressFromBase64(compressedString);
}

// Compressed dictionary passed by Flask in the render() function.
// NOTE: automatically generated.
// const FLASK_CTX_COMPRESSED = "N4IgygomYJIPIDkwgFwAIDaBdANGkAMhAOIQIAiy6wAvniORAGICCAqgQCoD6ACjOVT4AZgFMAzAA4ADAHYAnOIC0M8QFYlAFgCMm0UoBG040unyDYtaIDGo+QCYAhiHqNWHHpQichIAwHcAWxAaIA==";

// // Load the compressed data from FLASK_CTX_COMPRESSED
// const decompressedData = decompressFromBase64(FLASK_CTX_COMPRESSED);

// // Parse the decompressed data as JSON
// const FLASK_CTX = JSON.parse(decompressedData);

// We don't use compression here for the sake of simplicity.
const FLASK_CTX = {"SESSIONS": [{"DOB": "2022-03-03", "ID": "1ab86a7f-578b-4a46-9c9c-df3be97abcca", "Lab": "steinmetzlab", "N clusters": "73 good, 539 overall", "N spikes": "3150221", "N trials": "1191", "Probe name": "probe00", "Probe type": "3B2", "Recording date": "2022-08-22", "Recording length": "112 minutes", "Subject": "NR_0027", "_acronyms": ["STR"], "_cluster_ids": [27], "_colors": [[152, 214, 249]], "_duration": 6754.416170970875, "_good_ids": [true], "_regions": "anterior cingulate area dorsal part layer 6a, lateral septal nucleus rostral (rostroventral) part, lateral septal nucleus ventral part, nucleus accumbens, prelimbic area layer 6a, prelimbic area layer 6b, secondary motor area layer 5, secondary motor area layer 6a, striatum, acad6a, acb, lsr, lsv, mos5, mos6a, pl6a, pl6b, str", "_trial_ids": [400], "_trial_offsets": [5310.565], "_trial_onsets": [5319.434], "dset_bwm": true, "dset_rs": false, "eid": "0f77ca5d-73c2-45bd-aa4c-4c5ed275dbde", "pid": "1ab86a7f-578b-4a46-9c9c-df3be97abcca"}], "LEGENDS": {"figure1": {"A": {"coords": [0.05333333333333334, 0.040000000000000036, 0.46473684210526317, 0.41147058823529425], "legend": "Raster plot of the spikes of good units along the probe depth (um), throughout the whole experiment time (s)"}, "B": {"coords": [0.47649122807017547, 0.040000000000000036, 0.5450584795321638, 0.41147058823529425], "legend": "Amplitude (uV) of units along the probe depth (um), colored by the quality: good units in green, multi-units (mua) in red"}, "C": {"coords": [0.5568128654970761, 0.040000000000000036, 0.6253801169590644, 0.41147058823529425], "legend": "Amplitude (uV) of good units along the probe depth (um), colored by their firing rate (Hz)"}, "D": {"coords": [0.6371345029239767, 0.040000000000000036, 0.7057017543859649, 0.41147058823529425], "legend": "Root mean square (RMS) values of the action potential (AP) band along the probe depth (um)"}, "E": {"coords": [0.7174561403508772, 0.040000000000000036, 0.7860233918128655, 0.41147058823529425], "legend": "Power (dB) in the delta band (0-4Hz) of the low-frequency (LFP) band"}, "F": {"coords": [0.7977777777777778, 0.040000000000000036, 0.8663450292397661, 0.41147058823529425], "legend": "Slice of Allen Atlas showing location of probe in brain"}, "G": {"coords": [0.8780994152046784, 0.040000000000000036, 0.9466666666666667, 0.41147058823529425], "legend": "Brain region acronyms along the probe depth (um)"}, "H": {"coords": [0.05333333333333334, 0.48730392156862745, 0.46473684210526317, 0.6657352941176471], "legend": "Overview of task performance throughout the session. Top row shows the reaction time for each trial across the session. Bottom row shows the contrasts of each trial throughout the session. Blue circles indicate correct trials and red crosses incorrect trials. The red, black and blue backgrounds denote different blocks in the task where the probability of the stimulus being on the left hand side was0.2, 0.5 and 0.8 respectively."}, "I": {"coords": [0.7070664421518484, 0.48730392156862745, 0.876734727438795, 0.6657352941176471], "legend": "Coronal slice of Allen Atlas showing location of probe insertion"}, "J": {"coords": [0.05333333333333334, 0.7415686274509804, 0.8619677996422183, 0.92], "legend": "3 raw electrophysiology data snippets of 50 millisecond (ms) duration are shown (one at T=600s, 1800s, and 3000s). The raw data recorded on each channel is plotted as a gray code, and ordered along the probe depth. Divergence from the gray color (black or white) indicates a shift from baseline activity. Overlaid dots indicate when spikes were detected (green: good units, red: multi-units)."}, "K": {"coords": [0.8827429934406679, 0.7415686274509804, 0.9466666666666667, 0.92], "legend": "Brain region acronyms along the probe depth (um)"}}, "figure2": {"A": {"coords": [0.05333333333333334, 0.050000000000000044, 0.2647731755424063, 0.23913043478260876], "legend": "Psychometric curves computed in different types of trial block ; for a trial block type, the probability of the visual stimulus being on the left is either 0.5 (black), 0.2 (orange), or 0.8 (blue)"}, "B": {"coords": [0.455069033530572, 0.050000000000000044, 0.666508875739645, 0.23913043478260876], "legend": "Median reaction time (s) curves computed in different trial blocks (same color scheme as the psychometric curve plots)"}, "C": {"coords": [0.7352268244575937, 0.050000000000000044, 0.9466666666666667, 0.23913043478260876], "legend": "Reaction time (s) for each trial, plotted throughout the whole experiment"}, "D": {"coords": [0.05333333333333334, 0.352608695652174, 0.15843137254901962, 0.9200000000000002], "legend": "Raster plot of the left paw speed, sorted by trial outcome (correct in blue, incorrect in red) and aligned to the visual stimulus onset; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top. Left paw speed has been computed from DLC points detected on the left camera"}, "E": {"coords": [0.21098039215686276, 0.352608695652174, 0.31607843137254904, 0.9200000000000002], "legend": "Raster plot of the nose tip speed, sorted by trial outcome (correct in blue, incorrect in red) and aligned to the visual stimulus onset; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top. Nose tip speed has been computed from DLC points detected on the left camera"}, "F": {"coords": [0.3686274509803922, 0.352608695652174, 0.47372549019607846, 0.9200000000000002], "legend": "Raster plot of the whisker pad motion energy, sorted by trial outcome (correct in blue, incorrect in red) and aligned to the visual stimulus onset; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top. Motion energy has been computed using the left camera"}, "G": {"coords": [0.5262745098039215, 0.352608695652174, 0.6313725490196079, 0.9200000000000002], "legend": "Raster plot of smoothed pupil diameter, sorted by trial outcome (correct in blue, incorrect in red) and aligned to the visual stimulus onset; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top. The pupil diameter has been computed from DLC points on the left camera "}, "H": {"coords": [0.683921568627451, 0.352608695652174, 0.7890196078431373, 0.9200000000000002], "legend": "Raster plot of wheel velocity, sorted by visual stimulus side (right in yellow, left in green) and aligned to the movement onset ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top"}, "I": {"coords": [0.8415686274509805, 0.352608695652174, 0.9466666666666668, 0.9200000000000002], "legend": "Raster plot of lick events, sorted by visual stimulus side (right in yellow, left in green) and aligned to feedback time ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top. Lick events have been computed using DLC points detected on both the left and right cameras"}}, "figure3": {"A": {"coords": [0.06666666666666667, 0.08999999999999997, 0.3240448409974834, 0.5839965694682675], "legend": "Raster plot of the spikes of all good units along the probe depth (um), throughout the whole experiment time (s) ; the dash line indicates the trial selected for visualization"}, "B": {"coords": [0.3374857012125371, 0.08999999999999997, 0.8522420498741705, 0.5839965694682675], "legend": "Zoomed-in view of the raster around the time of the selected trial ; the lines indicate events in the trial (stim on in blue, first movement in green, and feedback in red)."}, "C": {"coords": [0.8656829100892243, 0.08999999999999997, 0.8999999999999998, 0.5839965694682675], "legend": "Brain region acronyms along the probe depth (um)"}, "D": {"coords": [0.3374857012125371, 0.6247512864493996, 0.8522420498741705, 0.7019382504288164], "legend": "Wheel position (normalised to position at first) during selected trial; the lines indicate events in the trial (stim on in blue, first movement in green, and feedback in red)"}, "E": {"coords": [0.3374857012125371, 0.7328130360205831, 0.8522420498741705, 0.81], "legend": "DLC detected left paw speed during selected trial; the lines indicate events in the trial (stim on in blue, first movement in green, and feedback in red)"}}, "figure4": {"A": {"coords": [0.06666666666666667, 0.1875, 0.3021739130434783, 0.8099999999999998], "legend": "Average of the firing rate (z-scored) for good units along the probe depths (um), aligned to visual stimulus onset"}, "B": {"coords": [0.33985507246376817, 0.1875, 0.5753623188405799, 0.8099999999999998], "legend": "Average of the firing rate (z-scored) for good units along the probe depths (um), aligned to first movement"}, "C": {"coords": [0.6130434782608697, 0.1875, 0.8485507246376813, 0.8099999999999998], "legend": "Average of the firing rate (z-scored) for good units along the probe depths (um), aligned to feedback"}, "D": {"coords": [0.8862318840579712, 0.1875, 0.9333333333333335, 0.8099999999999998], "legend": "Brain region acronyms along the probe depth (um)"}}, "figure5": {"A": {"coords": [0.05333333333333334, 0.050000000000000044, 0.15843137254901962, 0.4621052631578948], "legend": "Amplitude (uV) of good units along the probe depth (um), colored by the brain region color ; the selected unit for visualization is highlighted in black"}, "B": {"coords": [0.21098039215686276, 0.050000000000000044, 0.3252173913043479, 0.4621052631578948], "legend": "Raster plot of the spikes of the selected good unit, with the trial block type shown (the probability of the visual stimulus being on the left is either 0.5 (black), 0.2 (orange), or 0.8 (blue) and aligned to the visual stimulus onset ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers are ascending from bottom to top, and kept in a similar order as during the experiment"}, "C": {"coords": [0.3480647911338449, 0.050000000000000044, 0.46230179028133, 0.4621052631578948], "legend": "Raster plot of the spikes of the selected good unit, sorted by visual stimulus contrasts (0, 6.25, 12.5, 25, 100%, from pale to dark gray) and aligned to the visual stimulus onset ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top."}, "D": {"coords": [0.485149190110827, 0.050000000000000044, 0.5993861892583121, 0.4621052631578948], "legend": "Raster plot of the spikes of the selected good unit, sorted by visual stimulus side (right in yellow, left in green) and aligned to the movement onset ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top."}, "E": {"coords": [0.6222335890878092, 0.050000000000000044, 0.7364705882352942, 0.4621052631578948], "legend": "Raster plot of the spikes of the selected good unit, sorted by trial outcome (correct in blue, incorrect in red) and aligned to feedback time ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top."}, "F": {"coords": [0.7890196078431374, 0.050000000000000044, 0.9466666666666669, 0.6556644619570322], "legend": "Template waveforms of the selected good unit, presented for the electrode channels where spikes were detected. Scale bar indicates amplitude of waveforms in uV and as a ratio to the standard deviation of the noise on the peak channel. The location of electrode channels within the whole probe is presented on the right."}, "G": {"coords": [0.05333333333333334, 0.5536842105263159, 0.7364705882352943, 0.6910526315789475], "legend": "Tuning curves aligned to different task events. The firing rate has been computed using spikes in the range 50 - 400 ms post event"}, "H": {"coords": [0.05333333333333334, 0.7826315789473686, 0.3160784313725491, 0.9200000000000002], "legend": "Autocorrelogram of the selected good unit."}, "I": {"coords": [0.36862745098039224, 0.7826315789473686, 0.6313725490196079, 0.9200000000000002], "legend": "Inter-spike-interval (ISI) distribution for the selected good unit."}, "J": {"coords": [0.6839215686274511, 0.7826315789473686, 0.9466666666666669, 0.9200000000000002], "legend": "Amplitude (uV) of the spikes of the selected good unit across the experiment time (s)."}}, "figure5_qc": {"A": {"coords": [0.05333333333333334, 0.050000000000000044, 0.15043478260869567, 0.4621052631578948], "legend": "Amplitude (uV) of all units along the probe depth (um), colored by the brain region color ; the selected unit for visualization is highlighted in black"}, "B": {"coords": [0.1892753623188406, 0.050000000000000044, 0.29482041587901703, 0.4621052631578948], "legend": "Raster plot of the spikes of the selected unit, with the trial block type shown (the probability of the visual stimulus being on the left is either 0.5 (black), 0.2 (orange), or 0.8 (blue) and aligned to the visual stimulus onset ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers are ascending from bottom to top, and kept in a similar order as during the experiment"}, "C": {"coords": [0.31592942659105233, 0.050000000000000044, 0.4214744801512288, 0.4621052631578948], "legend": "Raster plot of the spikes of the selected unit, sorted by visual stimulus contrasts (0, 6.25, 12.5, 25, 100%, from pale to dark gray) and aligned to the visual stimulus onset ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top."}, "D": {"coords": [0.4425834908632641, 0.050000000000000044, 0.5481285444234405, 0.4621052631578948], "legend": "Raster plot of the spikes of the selected unit, sorted by visual stimulus side (right in yellow, left in green) and aligned to the movement onset ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top."}, "E": {"coords": [0.5692375551354758, 0.050000000000000044, 0.6747826086956523, 0.4621052631578948], "legend": "Raster plot of the spikes of the selected unit, sorted by trial outcome (correct in blue, incorrect in red) and aligned to feedback time ; averages (mean and STD) for each condition are displayed at the top with the same color scheme. Trial numbers within a condition are kept ascending from bottom to top."}, "F": {"coords": [0.7136231884057972, 0.050000000000000044, 0.9313414283489284, 0.6910526315789475], "legend": "Template waveforms of the selected unit, presented for the electrode channels where spikes were detected. Scale bar indicates amplitude of waveforms in uV and as a ratio to the standard deviation of the noise on the peak channel. The location of electrode channels within the whole probe is presented on the right."}, "G": {"coords": [0.05333333333333334, 0.5536842105263159, 0.6747826086956522, 0.6910526315789475], "legend": "Tuning curves aligned to different task events. The firing rate has been computed using spikes in the range 50 - 400 ms post event"}, "H": {"coords": [0.05333333333333334, 0.7826315789473686, 0.4593939393939394, 0.9200000000000002], "legend": "Amplitude (uV) of the spikes of the selected unit across the experiment time (s) and the distribution of the amplitude."}, "I": {"coords": [0.5406060606060606, 0.7826315789473686, 0.9097520661157024, 0.9200000000000002], "legend": "Autocorrelogram of the selected unit"}}}, "DEFAULT_EID": "65f90bf6-5124-430a-ab73-134ac6fb374f", "DEFAULT_DSET": "bwm"};

// Current context.
var CTX = {
    dset: QUERY_PARAMS.dset || FLASK_CTX.DEFAULT_DSET, // initial tab dataset
    eid: QUERY_PARAMS.eid || FLASK_CTX.DEFAULT_EID, // initial probe UUID
    tid: parseInt(QUERY_PARAMS.tid, 10) || 0, // trial ID
    trials: [],
    trial_onsets: [], // for all trials, including nan ones, so we can index by the tid
    trial_offsets: [],
    dur: 0, // session duration
};